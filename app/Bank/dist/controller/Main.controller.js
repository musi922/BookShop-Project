sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,i,n){"use strict";return e.extend("com.bank.controller.Main",{onInit:function(){let e=new t({selectedProgram:"",termsAccepted:false,currentStep:1,uploadedDocuments:"None",applicant:{fullName:"",email:"",phone:"",dateOfBirth:"",address:"",city:"",country:"",postalCode:""},project:{title:"",description:"",fundingAmount:"",duration:"",category:"",startDate:""},documents:{businessPlan:null,financialStatements:null}});this.getView().setModel(e);let i=new t({});this.getView().setModel(i,"config");this._programList={startup:"model/programs/startup.json",innovation:"model/programs/innovation.json",sme:"model/programs/sme.json",research:"model/programs/research.json"}},onProgramChange:function(e){let t=e.getParameter("selectedItem").getKey();if(!t){this._clearProgramConfig();return}this._loadProgramConfig(t)},_loadProgramConfig:function(e){let t=this._programList[e];if(!t){n.show("Program configuration not found.");return}sap.ui.core.BusyIndicator.show(0);let a=this.getView().getModel("config");a.loadData(t).then(function(){sap.ui.core.BusyIndicator.hide();let t=this.getView().getModel();t.setProperty("/selectedProgram",e);this._validateProgramStep();this._resetApplicantStep();this._resetProjectStep();n.show("Program configuration loaded successfully.")}.bind(this)).catch(function(e){sap.ui.core.BusyIndicator.hide();i.error("Failed to load program configuration: "+e.message)}.bind(this))},_clearProgramConfig:function(){let e=this.getView().getModel("config");e.setData({});let t=this.getView().getModel();t.setProperty("/selectedProgram","");this._validateProgramStep()},_validateProgramStep:function(){let e=this.getView().getModel();let t=this.byId("programStep");let i=!!e.getProperty("/selectedProgram");t.setValidated(i)},onApplicantFieldChange:function(){this._validateApplicantStep()},_validateApplicantStep:function(){let e=this.getView().getModel();let t=this.getView().getModel("config");let i=this.byId("applicantStep");let n=e.getProperty("/applicant");let a=t.getProperty("/steps/applicantInfo/fields");if(!a){i.setValidated(false);return}let o=true;for(let e in a){let t=a[e];if(t.visible&&t.required){let t=n[e];if(!t||t.trim()===""){o=false;break}}}if(o&&a.email&&a.email.visible&&n.email){let e=/^[^\s@]+@[^\s@][^\s.@]*\.[^\s@]+$/;o=e.test(n.email)}i.setValidated(o)},_resetApplicantStep:function(){let e=this.getView().getModel();e.setProperty("/applicant",{fullName:"",email:"",phone:"",dateOfBirth:"",address:"",city:"",country:"",postalCode:""});let t=this.byId("applicantStep");t.setValidated(false)},onProjectFieldChange:function(){this._validateProjectStep()},_validateProjectStep:function(){let e=this.getView().getModel();let t=this.getView().getModel("config");let i=this.byId("projectStep");let n=e.getProperty("/project");let a=t.getProperty("/steps/projectDetails/fields");let o=t.getProperty("/steps/projectDetails/documents");if(!a){i.setValidated(false);return}let s=true;for(let e in a){let t=a[e];if(t.visible&&t.required){let i=n[e];if(!i||typeof i==="string"&&i.trim()===""){s=false;break}if(e==="description"&&t.minLength){if(i.length<t.minLength){s=false;break}}if(e==="duration"&&t.max){if(parseInt(i)>t.max){s=false;break}}}}if(s&&n.fundingAmount){let e=parseInt(n.fundingAmount);let i=t.getProperty("/fundingRange");if(i){if(e<i.min||e>i.max){s=false}}}if(s&&o){if(o.businessPlan&&o.businessPlan.required){let e=this.byId("businessPlanUpload");if(e&&e.getItems().length===0){s=false}}if(o.financialStatements&&o.financialStatements.required){let e=this.byId("financialUpload");if(e&&e.getItems().length===0){s=false}}}i.setValidated(s)},_resetProjectStep:function(){let e=this.getView().getModel();e.setProperty("/project",{title:"",description:"",fundingAmount:"",duration:"",category:"",startDate:""});e.setProperty("/documents",{businessPlan:null,financialStatements:null});let t=this.byId("businessPlanUpload");if(t){t.removeAllItems()}let i=this.byId("financialUpload");if(i){i.removeAllItems()}let n=this.byId("projectStep");n.setValidated(false)},onFileUploaded:function(){this._updateUploadedDocumentsList();this._validateProjectStep()},onFileRemoved:function(){this._updateUploadedDocumentsList();this._validateProjectStep()},_updateUploadedDocumentsList:function(){let e=[];let t=this.byId("businessPlanUpload");if(t&&t.getItems().length>0){e.push("Business Plan")}let i=this.byId("financialUpload");if(i&&i.getItems().length>0){e.push("Financial Statements")}let n=e.length>0?e.join(", "):"None";this.getView().getModel().setProperty("/uploadedDocuments",n)},onStepActivate:function(e){let t=this.getView().getModel();let i=e.getParameter("index");t.setProperty("/currentStep",i+1);if(i>0){this._validateStepByIndex(i-1)}},_validateStepByIndex:function(e){switch(e){case 0:this._validateProgramStep();break;case 1:this._validateApplicantStep();break;case 2:this._validateProjectStep();break}},onWizardNext:function(){let e=this.byId("fundingWizard");let t=this.getView().getModel();let i=e.getProgress()-1;let n=e.getSteps();let a=n[i];this._validateStepByIndex(i);if(a&&a.getValidated()){e.nextStep();let i=e.getProgress();t.setProperty("/currentStep",i)}else{this._showValidationErrorMessage(i)}},_showValidationErrorMessage:function(e){let t=this.getView().getModel("config");let n="Please complete all required fields before proceeding.";switch(e){case 0:n="Please select a funding program.";break;case 1:n="Please fill in all required applicant information fields.";break;case 2:{let e=t.getProperty("/steps/projectDetails/fields");let i=t.getProperty("/steps/projectDetails/documents");let a=[];if(e){let i=this.getView().getModel();let n=i.getProperty("/project");if(e.description&&e.description.minLength){if(!n.description||n.description.length<e.description.minLength){a.push("Description must be at least "+e.description.minLength+" characters")}}if(e.duration&&e.duration.max){if(n.duration&&parseInt(n.duration)>e.duration.max){a.push("Duration cannot exceed "+e.duration.max+" months")}}if(n.fundingAmount){let e=t.getProperty("/fundingRange");let i=parseInt(n.fundingAmount);if(e&&(i<e.min||i>e.max)){a.push("Funding amount must be between "+e.min+" and "+e.max)}}}if(i){if(i.businessPlan&&i.businessPlan.required){let e=this.byId("businessPlanUpload");if(!e||e.getItems().length===0){a.push("Business Plan document is required")}}if(i.financialStatements&&i.financialStatements.required){let e=this.byId("financialUpload");if(!e||e.getItems().length===0){a.push("Financial Statements document is required")}}}if(a.length>0){n="Please fix the following issues:\n\n• "+a.join("\n• ")}else{n="Please complete all required project details."}break}}i.warning(n)},onWizardBack:function(){let e=this.byId("fundingWizard");let t=this.getView().getModel();e.previousStep();let i=e.getProgress();t.setProperty("/currentStep",i)},onWizardComplete:function(){},onTermsChange:function(e){let t=e.getParameter("selected");this.getView().getModel().setProperty("/termsAccepted",t)},onSubmitApplication:function(){let e=this.getView().getModel();let t=this.getView().getModel("config");if(!e.getProperty("/termsAccepted")){n.show("Please accept the terms and conditions to submit.");return}let i={program:t.getData(),applicant:e.getProperty("/applicant"),project:e.getProperty("/project"),documents:this._getUploadedDocumentsList(),submissionDate:(new Date).toISOString()};this._submitApplication(i)},_getUploadedDocumentsList:function(){let e=[];let t=this.byId("businessPlanUpload");if(t){t.getItems().forEach(function(t){e.push({type:"businessPlan",fileName:t.getFileName()})})}let i=this.byId("financialUpload");if(i){i.getItems().forEach(function(t){e.push({type:"financialStatements",fileName:t.getFileName()})})}return e},_submitApplication:function(e){sap.ui.core.BusyIndicator.show(0);setTimeout(function(){sap.ui.core.BusyIndicator.hide();let t="FA-"+e.program.programId.toUpperCase()+"-"+Date.now();let n=e.program.processingTime.value+" "+e.program.processingTime.unit;i.success("Your application has been submitted successfully!\n\n"+"Reference Number: "+t+"\n"+"Program: "+e.program.programName+"\n"+"Processing Time: "+n+"\n\n"+"You will receive a confirmation email shortly.",{title:"Application Submitted",onClose:function(){this._resetWizard()}.bind(this)})}.bind(this),2e3)},_resetWizard:function(){let e=this.byId("fundingWizard");let t=this.getView().getModel();let i=this.getView().getModel("config");t.setData({selectedProgram:"",termsAccepted:false,currentStep:1,uploadedDocuments:"None",applicant:{fullName:"",email:"",phone:"",dateOfBirth:"",address:"",city:"",country:"",postalCode:""},project:{title:"",description:"",fundingAmount:"",duration:"",category:"",startDate:""},documents:{businessPlan:null,financialStatements:null}});i.setData({});let n=this.byId("businessPlanUpload");if(n){n.removeAllItems()}let a=this.byId("financialUpload");if(a){a.removeAllItems()}e.discardProgress(this.byId("programStep"))},onDownloadPDF:function(){let e=this.getView().getModel("config");try{let t=this._prepareDownloadData();let i=this._generatePDFContent(t,e.getData());this._downloadFile(i,"funding-application.txt","text/plain");n.show("Application downloaded as text file (PDF generation requires jsPDF library)")}catch(e){console.error("PDF Generation Error:",e);i.error("Failed to generate PDF: "+e.message)}},onDownloadExcel:function(){let e=this.getView().getModel("config");try{let t=this._prepareDownloadData();let i=this._generateExcelContent(t,e.getData());this._downloadFile(i,"funding-application.csv","text/csv");n.show("Application downloaded as CSV (Excel compatible)")}catch(e){console.error("Excel Generation Error:",e);i.error("Failed to generate Excel: "+e.message)}},_prepareDownloadData:function(){let e=this.getView().getModel();let t=this.getView().getModel("config");return{program:{name:t.getProperty("/programName")||"",id:t.getProperty("/programId")||"",fundingRange:t.getProperty("/fundingRange")||{},processingTime:t.getProperty("/processingTime")||{}},applicant:e.getProperty("/applicant")||{},project:e.getProperty("/project")||{},documents:e.getProperty("/uploadedDocuments")||"None",submissionDate:(new Date).toLocaleString()}},_generatePDFContent:function(e,t){let i=[];i.push("FUNDING APPLICATION");i.push("===================\n");i.push("Generated: "+e.submissionDate);i.push("\n");i.push("PROGRAM INFORMATION");i.push("-------------------");i.push("Program: "+e.program.name);i.push("Program ID: "+e.program.id);if(e.program.fundingRange){i.push("Funding Range: "+e.program.fundingRange.min+" - "+e.program.fundingRange.max+" "+e.program.fundingRange.currency)}if(e.program.processingTime){i.push("Processing Time: "+e.program.processingTime.value+" "+e.program.processingTime.unit)}i.push("\n");if(t.steps&&t.steps.applicantInfo&&t.steps.applicantInfo.enabled){i.push("APPLICANT INFORMATION");i.push("---------------------");if(e.applicant.fullName)i.push("Full Name: "+e.applicant.fullName);if(e.applicant.email)i.push("Email: "+e.applicant.email);if(e.applicant.phone)i.push("Phone: "+e.applicant.phone);if(e.applicant.dateOfBirth)i.push("Date of Birth: "+e.applicant.dateOfBirth);if(e.applicant.address)i.push("Address: "+e.applicant.address);if(e.applicant.city)i.push("City: "+e.applicant.city);if(e.applicant.country)i.push("Country: "+e.applicant.country);if(e.applicant.postalCode)i.push("Postal Code: "+e.applicant.postalCode);i.push("\n")}if(t.steps&&t.steps.projectDetails&&t.steps.projectDetails.enabled){i.push("PROJECT DETAILS");i.push("---------------");if(e.project.title)i.push("Project Title: "+e.project.title);if(e.project.description)i.push("Description: "+e.project.description);if(e.project.fundingAmount)i.push("Funding Amount: "+e.project.fundingAmount+" RWF");if(e.project.duration)i.push("Duration: "+e.project.duration+" months");if(e.project.category)i.push("Category: "+e.project.category);if(e.project.startDate)i.push("Start Date: "+e.project.startDate);i.push("Documents: "+e.documents);i.push("\n")}return i.join("\n")},_generateExcelContent:function(e,t){let i=[];i.push(["FUNDING APPLICATION"]);i.push([]);i.push(["Generated:",e.submissionDate]);i.push([]);i.push(["PROGRAM INFORMATION"]);i.push(["Program",e.program.name]);i.push(["Program ID",e.program.id]);if(e.program.fundingRange){i.push(["Funding Range",e.program.fundingRange.min+" - "+e.program.fundingRange.max+" "+e.program.fundingRange.currency])}if(e.program.processingTime){i.push(["Processing Time",e.program.processingTime.value+" "+e.program.processingTime.unit])}i.push([]);if(t.steps&&t.steps.applicantInfo&&t.steps.applicantInfo.enabled){i.push(["APPLICANT INFORMATION"]);if(e.applicant.fullName)i.push(["Full Name",e.applicant.fullName]);if(e.applicant.email)i.push(["Email",e.applicant.email]);if(e.applicant.phone)i.push(["Phone",e.applicant.phone]);if(e.applicant.dateOfBirth)i.push(["Date of Birth",e.applicant.dateOfBirth]);if(e.applicant.address)i.push(["Address",e.applicant.address]);if(e.applicant.city)i.push(["City",e.applicant.city]);if(e.applicant.country)i.push(["Country",e.applicant.country]);if(e.applicant.postalCode)i.push(["Postal Code",e.applicant.postalCode]);i.push([])}if(t.steps&&t.steps.projectDetails&&t.steps.projectDetails.enabled){i.push(["PROJECT DETAILS"]);if(e.project.title)i.push(["Project Title",e.project.title]);if(e.project.description)i.push(["Description",e.project.description]);if(e.project.fundingAmount)i.push(["Funding Amount",e.project.fundingAmount+" RWF"]);if(e.project.duration)i.push(["Duration",e.project.duration+" months"]);if(e.project.category)i.push(["Category",e.project.category]);if(e.project.startDate)i.push(["Start Date",e.project.startDate]);i.push(["Documents",e.documents])}let n=i.map(function(e){return e.map(function(e){let t=e||"";if(t.toString().indexOf(",")>-1||t.toString().indexOf('"')>-1){t='"'+t.toString().replace(/"/g,'""')+'"'}return t}).join(",")}).join("\n");return n},_downloadFile:function(e,t,i){let n=new Blob([e],{type:i});let a=document.createElement("a");a.href=window.URL.createObjectURL(n);a.download=t;document.body.appendChild(a);a.click();document.body.removeChild(a);window.URL.revokeObjectURL(a.href)}})});
//# sourceMappingURL=Main.controller.js.map