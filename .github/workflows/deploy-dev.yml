name: Deploy to Dev Environment

on:
  push:
    branches:
      - dev
  workflow_dispatch:

env:
  CF_API: https://api.cf.us10.hana.ondemand.com
  CF_ORG: ${{ secrets.CF_ORG_DEV }}
  CF_SPACE: ${{ secrets.CF_SPACE_DEV }}

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install app dependencies
        run: |
          cd app
          npm ci

      - name: Install Bank app dependencies
        run: |
          cd app/Bank
          npm ci

      - name: Run ESLint
        run: npm run lint --if-present || npx eslint . --ext .js,.cds

      - name: Run Tests
        run: npm test --if-present || echo "No tests configured"

      - name: Build Application
        run: npx cds build --production

  build-mta:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install MTA Build Tool
        run: npm install -g mbt

      - name: Install dependencies
        run: npm ci

      - name: Build MTA Archive
        run: mbt build -t mta_archives

      - name: Upload MTA Archive
        uses: actions/upload-artifact@v4
        with:
          name: mta-archive
          path: mta_archives/*.mtar
          retention-days: 7

  deploy-to-dev:
    runs-on: ubuntu-latest
    needs: build-mta
    environment:
      name: development
      url: ${{ steps.deploy.outputs.app_url }}
    
    steps:
      - name: Download MTA Archive
        uses: actions/download-artifact@v4
        with:
          name: mta-archive
          path: mta_archives

      - name: Install Cloud Foundry CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install cf8-cli

      - name: Install MultiApps CF Plugin
        run: cf install-plugin multiapps -f

      - name: CF Login
        run: |
          cf api ${{ env.CF_API }}
          cf auth ${{ secrets.CF_USER_DEV }} ${{ secrets.CF_PASSWORD_DEV }}
          cf target -o ${{ env.CF_ORG }} -s ${{ env.CF_SPACE }}

      - name: Deploy to Cloud Foundry
        id: deploy
        run: |
          MTAR_FILE=$(ls mta_archives/*.mtar | head -n 1)
          echo "Deploying $MTAR_FILE to DEV environment"
          cf deploy $MTAR_FILE -f
          
          # Get application URL
          APP_URL=$(cf apps | grep "study" | awk '{print $6}' | head -n 1)
          echo "app_url=https://$APP_URL" >> $GITHUB_OUTPUT

      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests..."
          # Add your smoke tests here
          # curl -f https://your-app-url/health || exit 1

      - name: Logout
        if: always()
        run: cf logout

  notify-deployment:
    runs-on: ubuntu-latest
    needs: deploy-to-dev
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          echo "Deployment to DEV environment completed"
          echo "Status: ${{ needs.deploy-to-dev.result }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"