name: ESLint - Detailed PR Check

on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - '**.js'
      - '**.cds'
      - 'eslint.config.mjs'
      - 'package.json'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  eslint-full-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps --legacy-peer-deps

      - name: Install app dependencies
        run: |
          cd app
          npm ci --legacy-peer-deps

      - name: Install Bank app dependencies
        run: |
          cd app/Bank
          npm ci --legacy-peer-deps

      - name: Run ESLint on all files
        run: |
          echo "Running ESLint on entire project..."
          npx eslint . --ext .js,.cds --format json --output-file eslint-report.json || true
          npx eslint . --ext .js,.cds --format stylish

      - name: Upload ESLint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-report
          path: eslint-report.json

  eslint-changed-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(js|cds)$' || true)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run ESLint on changed files
        if: steps.changed-files.outputs.changed_files != ''
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.changed_files }}"
          echo ""
          echo "Running ESLint on changed files only..."
          echo "${{ steps.changed-files.outputs.changed_files }}" | xargs npx eslint --format stylish

      - name: Check ESLint errors
        if: steps.changed-files.outputs.changed_files != ''
        run: |
          ERRORS=$(echo "${{ steps.changed-files.outputs.changed_files }}" | xargs npx eslint --format json | jq '[.[].errorCount] | add')
          WARNINGS=$(echo "${{ steps.changed-files.outputs.changed_files }}" | xargs npx eslint --format json | jq '[.[].warningCount] | add')
          
          echo "ESLint Results:"
          echo "Errors: $ERRORS"
          echo "Warnings: $WARNINGS"
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "âŒ ESLint found $ERRORS error(s)"
            exit 1
          fi
          
          if [ "$WARNINGS" -gt 10 ]; then
            echo "âš ï¸ Too many warnings: $WARNINGS (max: 10)"
            exit 1
          fi
          
          echo "âœ… ESLint check passed"

  eslint-rules-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Check specific ESLint rules
        run: |
          echo "Checking for critical code patterns..."
          
          # Check for console.log in production code
          echo "1. Checking for console.log statements..."
          if grep -r "console\.log" srv --include="*.js" --exclude-dir=node_modules; then
            echo "âŒ Found console.log in srv/ - remove for production"
            exit 1
          fi
          
          # Check for debugger statements
          echo "2. Checking for debugger statements..."
          if grep -r "debugger" . --include="*.js" --exclude-dir=node_modules; then
            echo "âŒ Found debugger statements - remove for production"
            exit 1
          fi
          
          # Check for var usage (should use let/const)
          echo "3. Checking for var usage..."
          if grep -r "^\s*var " . --include="*.js" --exclude-dir=node_modules; then
            echo "âš ï¸ Found 'var' usage - consider using 'let' or 'const'"
          fi
          
          # Check for TODO/FIXME
          echo "4. Checking for TODO/FIXME comments..."
          TODO_COUNT=$(grep -r "TODO\|FIXME" . --include="*.js" --include="*.cds" --exclude-dir=node_modules | wc -l || true)
          echo "Found $TODO_COUNT TODO/FIXME comments"
          
          echo "âœ… Code pattern checks completed"

  code-quality-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Calculate code complexity
        run: |
          echo "Analyzing code complexity..."
          npx eslint . --ext .js --format json | jq '.[] | select(.messages | length > 0) | {filePath, errorCount, warningCount}' || true

      - name: Comment PR with ESLint results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = `## ESLint Check Results
            
            âœ… ESLint analysis completed
            
            ðŸ“Š **Summary:**
            - PR: #${{ github.event.pull_request.number }}
            - Branch: \`${{ github.head_ref }}\`
            - Commit: ${{ github.sha }}
            
            Please review any warnings or errors in the workflow logs.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });